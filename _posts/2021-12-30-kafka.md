---
layout:     post
title:      kafka
subtitle:   一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者在网站中的所有动作流数据
date:       2021-12-30
author:     果然
header-img: img/timg.jpg
catalog: true
tags:
    - 大数据组件技术选型
---

[**kafka**](https://www.cnblogs.com/qingyunzong/p/9004509.html)是一种高吞吐量的分布式发布订阅消息系统，可以处理消费者在网站中的所有动作流数据。   
主要应用场景是：日志收集系统和消息系统。  

[**kafka与zookeeper关系**](https://www.cnblogs.com/cuiyuanhao/p/13410442.html)：通过 zookeeper 管理集群配置，选举 leader，以及在 consumer group发生变化时进行 rebalance。  
**zookeeper 作用**：管理 broker、consumer，将元数据信息保存在 zookeeper 中。  
**producer**：使用 push 模式将消息发布到 broker  
**consumer**：使用 pull 模式从 broker 订阅并消费消息  

基于 kafka 与 zookeeper 的关系，因此zookeeper的使用可以单独安装，也可以使用 kafka 自带的。  

这里，我们单独安装zookeeper，因为其他组件，如 hbase 在实现 HA 选举与主备集群主节点的切换等于 zk 有关系。  
## 单机安装  
需下载组件  
**apache-zookeeper-3.7.0-bin.tar.gz**  
**kafka_2.11-0.10.1.0.tgz**   
```
# zk  
sudo tar -zxvf apache-zookeeper-3.7.0-bin.tar.gz -C /usr/local/
sudo mv apache-zookeeper-3.7.0-bin.tar.gz zookeeper
sudo chown -R hadoop:hadoop zookeeper
cp zoo_sample.cfg zoo.cfg
sudo vim zoo.cfg  
dataDir=/usr/local/zookeeper/data  

# zk 启动 
./bin/zkServer.sh start
./bin/zkServer.sh status

# 通过查看 zk 进程确定启动成功与否 
ps -ef | grep zookeeper 

# 还可以设置 zk 开机自启动
sudo vim zookeeper  
``
#!/bin/bash
#chkconfig:2345 20 90
#description:zookeeper
#processname:zookeeper
ZK_PATH=/usr/local/zookeeper
export JAVA_HOME=/usr/java/jdk1.8.0_162
case $1 in
         start) sh  $ZK_PATH/bin/zkServer.sh start;;
         stop)  sh  $ZK_PATH/bin/zkServer.sh stop;;
         status) sh  $ZK_PATH/bin/zkServer.sh status;;
         restart) sh $ZK_PATH/bin/zkServer.sh restart;;
         *)  echo "require start|stop|status|restart"  ;;
esac
``
# 在 root用户 下操作，添加执行权限
su root
chmod +x zookeeper 
# 添加到开机权限
chkconfig --add zookeeper
# kafka 
sudo tar -zxvf kafka_2.11-0.10.1.0.tgz -C /usr/local/
sudo mv kafka_2.11-0.10.1.0.tgz kafka
sudo chown -R hadoop:hadoop kafka
sudo vim ./config/server.properties
``
zookeeper.connect=192.168.184.131:2181
``
```   
## 测试  
```
sudo service zookeeper start
# 查看状态
ps -ef | grep zookeeper  
nohup ./bin/kafka-server-start.sh ./config/server.properties &
# 创建新 topic
./bin/kafka-topics.sh --create --zookeeper 192.168.184.131:2181 --replication-factor 1 --partitions 1 --topic test
# 查看 topic
./bin/kafka-topics.sh --list --zookeeper xxx:2181 
# 产生消息
./bin/kafka-console-producer.sh --broker-list xxx:9092 --topic test
# 消费消息
# 0.8 版本及以下的kafka使用如下命令
./bin/kafka-console-consumer.sh --zookeeper xxx:2181 --topic test --from-beginning
# 0.9 版本及以上kafka建议使用以下命令进行消费，
./bin/kafka-console-consumer.sh --bootstrap-server xxx:9092 --topic test --from-beginning
```  
## kafka 删除 topic  
[彻底删除 kafka 中的 topic marked for deletion](https://blog.csdn.net/russle/article/details/82881297)  
```
# 删除命令
./kafka-topics --delete --zookeeper {zookeeper server} --topic {topic name}
```  
此时，显示 marked for deletion.  
除了一般的删除/tmp/kafka_logs和设置 delete.topic.enable=true，有时我们需要在 zookeeper client中[删除对应的节点](https://blog.csdn.net/YG_wangxinA/article/details/107943117).  

![删除topic](https://initialdream16.github.io/img/zkCli.png)  

使用命令  
```
deleteall /admin
deleteall /brokers
``` 

## bugs  
* [Client port found: 2181. Client address: localhost. Client SSL: false. Error contacting](https://blog.csdn.net/qq_924485343/article/details/115963637)  
改安装 apache-zookeeper-3.7.0-bin.tar.gz 解决。  
* [/OPT/MODULE/KAFKA/BIN/KAFKA-RUN-CLASS.SH: 第 258 行:EXEC: JAVA: 未找到](https://www.freesion.com/article/24431404355/)  

```
# 设置kafka 的启动脚本
#!/bin/bash
case $1 in
"start"){
	sudo ssh 192.168.184.131 "/usr/local/kafka/bin/kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties "
};;
"stop"){
	sudo ssh 192.168.184.131 "/usr/local/kafka/bin/kafka-server-stop.sh stop"
};;
esac
```  
通过设置软链接：
```
ln -s /usr/java/jdk1.8.0_162/bin/java /usr/bin/java
```
